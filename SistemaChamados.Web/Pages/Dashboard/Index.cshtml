@page
@model SistemaChamados.Web.Pages.Dashboard.IndexModel
@{
    ViewData["Title"] = "Dashboard";
    ViewData["PageTitle"] = "Painel";
    ViewData["ActivePage"] = "Dashboard";
}

<div class="topbar">
    <div class="search">
        <input id="searchInput" type="text" placeholder="Buscar chamado, título ou ID..." />
    </div>
    <div class="center">
        <a href="/Chamados/Novo" class="btn btn-ghost">Novo Chamado</a>
        <a href="/Relatorios" class="btn btn-primary" style="margin-left:10px">Gerar Relatório</a>
    </div>
</div>

<section class="stats">
    <div class="stat-card card">
        <div class="card-title">Chamados Abertos</div>
        <div class="value">@Model.DashboardData.ChamadosAbertos</div>
        <div class="label small text-muted">Últimas 24h</div>
    </div>
    <div class="stat-card card">
        <div class="card-title">Em Análise</div>
        <div class="value">@Model.DashboardData.ChamadosEmAnalise</div>
        <div class="label small text-muted">Atribuídos</div>
    </div>
    <div class="stat-card card">
        <div class="card-title">Finalizados</div>
        <div class="value">@Model.DashboardData.FinalizadosMes</div>
        <div class="label small text-muted">Últimos 30 dias</div>
    </div>
</section>

<section class="card mt-3">
    <div class="card-title">Gráficos de Desempenho</div>
    <div class="row mt-3">
        <div class="col-md-6">
            <div style="background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005)); padding:16px; border-radius:10px; border:1px solid rgba(255,255,255,0.02);">
                <h6 style="color:#cfeffd; margin-bottom:12px; font-size:14px;">Chamados por Status</h6>
                <div style="position:relative; height:280px;">
                    <canvas id="chartStatus"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div style="background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005)); padding:16px; border-radius:10px; border:1px solid rgba(255,255,255,0.02);">
                <h6 style="color:#cfeffd; margin-bottom:12px; font-size:14px;">Chamados por Mês</h6>
                <div style="position:relative; height:280px;">
                    <canvas id="chartMensal"></canvas>
                </div>
            </div>
        </div>
    </div>
</section>

<section class="card mt-3">
    <div class="card-title">Chamados Recentes</div>
    <div class="tickets mt-2">
        @if (Model.DashboardData.ChamadosRecentes != null && Model.DashboardData.ChamadosRecentes.Any())
        {
            @foreach (var chamado in Model.DashboardData.ChamadosRecentes.Take(8))
            {
                <div class="ticket">
                    <div>
                        <div style="font-weight:700;color:#e8fbff">@chamado.Titulo</div>
                        <div class="meta small text-muted">ID #@chamado.Id — @chamado.Solicitante</div>
                    </div>
                    <div style="display:flex;gap:10px;align-items:center">
                        <div class="status @(chamado.Status == "Aguardando atribuição" ? "status-open" : chamado.Status == "Finalizado" ? "status-closed" : "")">
                            @chamado.Status.ToUpper()
                        </div>
                        <a href="/Chamados/Detalhes?id=@chamado.Id" class="btn btn-ghost">Ver</a>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="empty" style="display:block;">Nenhum chamado no momento — o sistema começou agora.</div>
        }
    </div>
</section>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        // Dados para o gráfico de pizza (Status)
        const dadosStatus = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.DashboardData.ChamadosPorStatus));
        
        // Dados para o gráfico de barras (Mensal)
        const dadosMensal = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.DashboardData.ChamadosPorMes));

        // Configuração de cores para tema escuro
        Chart.defaults.color = '#dbeaf8';
        Chart.defaults.borderColor = 'rgba(255,255,255,0.06)';

        // Gráfico de Pizza - Chamados por Status
        const ctxStatus = document.getElementById('chartStatus').getContext('2d');
        new Chart(ctxStatus, {
            type: 'pie',
            data: {
                labels: dadosStatus.map(d => d.label),
                datasets: [{
                    data: dadosStatus.map(d => d.valor),
                    backgroundColor: [
                        '#0ea5e9',
                        '#10b981',
                        '#f59e0b',
                        '#ef4444',
                        '#8b5cf6'
                    ],
                    borderColor: 'rgba(255,255,255,0.1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: '#dbeaf8',
                            padding: 12,
                            font: { size: 12 }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(10,14,20,0.95)',
                        titleColor: '#dff4ff',
                        bodyColor: '#cfe9f6',
                        borderColor: 'rgba(14,165,233,0.2)',
                        borderWidth: 1,
                        padding: 12,
                        callbacks: {
                            label: function(context) {
                                const item = dadosStatus[context.dataIndex];
                                return `${item.label}: ${item.valor} (${item.percentual.toFixed(1)}%)`;
                            }
                        }
                    }
                }
            }
        });

        // Gráfico de Barras - Chamados por Mês
        const ctxMensal = document.getElementById('chartMensal').getContext('2d');
        new Chart(ctxMensal, {
            type: 'bar',
            data: {
                labels: dadosMensal.map(d => d.mesFormatado),
                datasets: [
                    {
                        label: 'Total',
                        data: dadosMensal.map(d => d.quantidade),
                        backgroundColor: 'rgba(14,165,233,0.7)',
                        borderColor: '#0ea5e9',
                        borderWidth: 1
                    },
                    {
                        label: 'Finalizados',
                        data: dadosMensal.map(d => d.finalizados),
                        backgroundColor: 'rgba(16,185,129,0.7)',
                        borderColor: '#10b981',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: '#dbeaf8',
                            padding: 12,
                            font: { size: 12 }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(10,14,20,0.95)',
                        titleColor: '#dff4ff',
                        bodyColor: '#cfe9f6',
                        borderColor: 'rgba(14,165,233,0.2)',
                        borderWidth: 1,
                        padding: 12
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1,
                            color: '#dbeaf8'
                        },
                        grid: {
                            color: 'rgba(255,255,255,0.03)'
                        }
                    },
                    x: {
                        ticks: {
                            color: '#dbeaf8'
                        },
                        grid: {
                            color: 'rgba(255,255,255,0.03)'
                        }
                    }
                }
            }
        });
    </script>
}
